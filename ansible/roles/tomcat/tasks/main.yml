#SPDX-License-Identifier: MIT-0
---
# tasks file for tomcat
# 1. Install Java
- name: Install Java
  apt:
    name: "{{ java_package }}"
    state: latest
  when: ansible_os_family == "Debian"

# 2. Create group
- name: Create tomcat group
  group:
    name: "{{ tomcat_group }}"

# 3. Create user
- name: Create tomcat user
  user:
    name: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    shell: /bin/false

# 4. Download Tomcat package
- name: Download tomcat tar file
  get_url:
    url: "https://archive.apache.org/dist/tomcat/tomcat-9/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz"
    dest: /tmp/tomcat.tar.gz

# 5. Extract Tomcat
- name: Extract Tomcat
  unarchive:
    src: /tmp/tomcat.tar.gz
    dest: "{{ tomcat_install_dir }}"
    remote_src: yes
    creates: "{{ tomcat_install_dir }}/apache-tomcat-{{ tomcat_version }}"

# 6. Change ownership
- name: Set permissions
  file:
    path: "{{ tomcat_install_dir }}"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    recurse: yes

# 7. Tomcat systemd service
- name: Deploy Tomcat service file
  template:
    src: tomcat.service.j2
    dest: /etc/systemd/system/tomcat.service
  notify: restart tomcat

# 8. Deploy static website
- name: Deploy static website  
  copy:
    src: "{{ website_src }}"
    dest: "{{ website_dest }}"
  notify: restart tomcat

# 9. Start Tomcat
- name: Start Tomcat
  systemd:
    name: tomcat
    state: started
    enabled: yes
